{"diagram":{"elements":{"leftChildren":[],"note":"","watermark":"","children":[{"parent":"root","lineStyle":{"randomLineColor":"#BE49C4"},"children":[{"parent":"398368f68e6076c9","children":[],"id":"43cb79556f882e02","title":"// 挂接钩子函数，用于处理MarketMap模块关于增删货币对的处理<br>app.<b>MarketMapKeeper</b>.SetHooks(app.OracleKeeper.Hooks())"},{"parent":"398368f68e6076c9","children":[{"parent":"0aa0c59bb0d6e976","children":[],"id":"9f8d5808ec7ad72a","title":"// 读取配置构建oracle服务<br><b>cfg</b> := oracleconfig.<b>ReadConfigFromAppOpts</b>(appOpts)<br>"},{"parent":"0aa0c59bb0d6e976","children":[],"id":"6890b31e168df3fb","title":"// 用于度量跟踪延时<br>oracleMetrics := servicemetrics.NewMetricsFromConfig(app.ChainID())<br>"},{"parent":"0aa0c59bb0d6e976","children":[],"id":"20c5d46d60d283fc","title":"// 构建 oracle service.<br>app.<b>oracleClient</b> = oracleclient.<b>NewClientFromConfig</b>(cfg,oracleMetrics,)"},{"parent":"0aa0c59bb0d6e976","children":[],"id":"96e9826734fb5c90","title":"// 连接oracle service (default timeout of 5 seconds).<br><b>go</b> func() {app.<b>oracleClient.Start</b>(context.Background())<br><br>"}],"id":"0aa0c59bb0d6e976","title":"1、初始化ORACLE客户端"},{"parent":"398368f68e6076c9","children":[{"parent":"845d6a016c7bfc44","children":[],"id":"1b4c781459c27308","title":"<b><font color=\"#e74f4c\">proposalHandler</font></b> := proposals.NewProposalHandler(<br>&nbsp; &nbsp; baseapp.<b>NoOpPrepareProposal</b>(),// 无操作的空函数<br>&nbsp; &nbsp; baseapp.<b>NoOpProcessProposal</b>(),// 无操作的空函数<br>&nbsp; &nbsp; ve.<b>NewDefaultValidateVoteExtensionsFn</b>(app.StakingKeeper),<br>&nbsp; &nbsp; compression.<b>NewCompressionVoteExtensionCodec</b>(),<br>&nbsp; &nbsp; compression.<b>NewCompressionExtendedCommitCodec</b>(),<br>&nbsp; &nbsp; currencypair.<b>NewDeltaCurrencyPairStrategy</b>(app.OracleKeeper),<br>)"},{"parent":"845d6a016c7bfc44","children":[],"id":"78ab11306a22cdf0","title":"app.<b>SetPrepareProposal</b>(<font color=\"#e74f4c\">proposalHandler</font>.PrepareProposalHandler())<br>"},{"parent":"845d6a016c7bfc44","children":[],"id":"4b78b36af1bc0807","title":"app.<b>SetProcessProposal</b>(<font color=\"#e74f4c\">proposalHandler</font>.ProcessProposalHandler())"}],"id":"845d6a016c7bfc44","title":"2、<b>ProposaHhandler</b>"},{"parent":"398368f68e6076c9","children":[{"parent":"83faa202ac917e09","children":[],"id":"65431fd6e9a9783d","title":"// 构建预言机的聚合函数：取power的中间位价格<br><b><font color=\"#ec7270\">aggregatorFn</font></b> := <b>voteweighted</b>.<b>MedianFromContext</b>(app.StakingKeeper,voteweighted.DefaultPowerThreshold,)"},{"parent":"83faa202ac917e09","children":[],"id":"e3d6dc4a3a2ce12f","title":"<b><font color=\"#a23735\">oraclePreBlockHandler</font></b> := oraclepreblock.<b>NewOraclePreBlockHandler</b>(<br>&nbsp; &nbsp; <b><font color=\"#ec7270\">aggregatorFn</font></b>, app.<b>OracleKeeper</b>,<br>&nbsp; &nbsp; currencypair.<b>NewDeltaCurrencyPairStrategy</b>(app.OracleKeeper),<br>&nbsp; &nbsp; compression.<b>NewCompressionVoteExtensionCodec</b>(),<br>&nbsp; &nbsp; compression.<b>NewCompressionExtendedCommitCodec</b>(),<br>)"},{"parent":"83faa202ac917e09","children":[],"id":"ddaf47b5592352dc","title":"// 设置PreBlockHandler<br>app.<b>SetPreBlocker</b>(<b><font color=\"#a23735\">oraclePreBlockHandler</font></b>.PreBlocker())<br>"}],"id":"83faa202ac917e09","title":"3、<b>PreBlockHandler:</b>"},{"parent":"398368f68e6076c9","children":[{"parent":"75e61141878bd9ea","children":[],"id":"d17867e1b3470ea7","title":"<b><font color=\"#ed9745\">voteExtensionsHandler</font></b> := ve.<b>NewVoteExtensionHandler</b>(<br>&nbsp; &nbsp; app.<b>oracleClient</b>, time.Second,<br>&nbsp; &nbsp; currencypair.<b>NewDeltaCurrencyPairStrategy</b>(app.OracleKeeper),<br>&nbsp; &nbsp; compression.<b>NewCompressionVoteExtensionCodec</b>(),<br>&nbsp; &nbsp; <b><font color=\"#a23735\">oraclePreBlockHandler</font></b>.<b><font color=\"#a23735\">PreBlocker</font></b>(),<br>)"},{"parent":"75e61141878bd9ea","children":[],"id":"0202538d90a4f94e","title":"app.<b>SetExtendVoteHandler</b>(<b><font color=\"#ed9745\">voteExtensionsHandler</font></b>.ExtendVoteHandler())<br>"},{"parent":"75e61141878bd9ea","children":[],"id":"df23ad54022e508e","title":"app.<b>SetVerifyVoteExtensionHandler</b>(<b><font color=\"#ed9745\">voteExtensionsHandler</font></b>.VerifyVoteExtensionHandler())"}],"id":"75e61141878bd9ea","title":"4、<b>voteExtensionsHandler</b>：<br>"}],"id":"398368f68e6076c9","title":"app应用集成步骤"},{"parent":"root","lineStyle":{"randomLineColor":"#DD489D"},"children":[{"parent":"812b3a9306dd","children":[{"parent":"4d70d73dad33","children":[],"id":"713fea71cb97f2c6","title":"type <b>ProposalHandler</b> struct {<br>&nbsp; &nbsp; <b>prepareProposalHandler</b> sdk.PrepareProposalHandler<br>&nbsp; &nbsp; <b>processProposalHandler</b> sdk.ProcessProposalHandler<br>&nbsp; &nbsp; <b>validateVoteExtensionsFn</b> ve.ValidateVoteExtensionsFn<br>&nbsp; &nbsp; <b>voteExtensionCodec</b> codec.VoteExtensionCodec<br>&nbsp; &nbsp; <b>extendedCommitCodec</b> codec.ExtendedCommitCodec<br>&nbsp; &nbsp; <b>currencyPairStrategy</b> currencypair.CurrencyPairStrategy<br>}"},{"parent":"4d70d73dad33","children":[{"parent":"2b8e24b2e67c6126","children":[],"id":"422b1b3017ba3146","title":"<b>handler</b> := &amp;<b>ProposalHandler</b>{<br>&nbsp; &nbsp; prepareProposalHandler:&nbsp; &nbsp;prepareProposalHandler,<br>&nbsp; &nbsp; processProposalHandler:&nbsp; &nbsp;processProposalHandler,<br>&nbsp; &nbsp; validateVoteExtensionsFn: validateVoteExtensionsFn,<br>&nbsp; &nbsp; voteExtensionCodec:&nbsp; &nbsp; &nbsp; &nbsp;voteExtensionCodec,<br>&nbsp; &nbsp; extendedCommitCodec:&nbsp; &nbsp; &nbsp; extendedCommitInfoCodec,<br>&nbsp; &nbsp; currencyPairStrategy:&nbsp; &nbsp; &nbsp;currencyPairStrategy,<br>}"}],"id":"2b8e24b2e67c6126","title":"<b>NewProposalHandler</b>()"},{"parent":"4d70d73dad33","children":[{"parent":"2cf90a050361d91e","children":[],"id":"71f94908ab3fdfd3","title":"// 验证本地最新的commit中的扩展信息<br><b>extInfo</b> := req.<b>LocalLastCommit</b><br>h.<b>ValidateExtendedCommitInfo</b>(req.<b>Height</b>, <b>extInfo</b>)<br>"},{"parent":"2cf90a050361d91e","children":[],"id":"dbd237b02138c546","title":"// 解析commit的扩展信息<br><b>extInfoBz</b> = h.<b>extendedCommitCodec</b>.Encode(<b>extInfo</b>)<br>"},{"parent":"2cf90a050361d91e","children":[{"parent":"1e8d6faea92b87d0","children":[],"id":"b88d9cfc842febbd","title":"// 为VE Tx 保留字节,调整req.MaxTxBytes大小<br>if <b>extInfoBzSize</b> &lt; req.<b>MaxTxBytes</b> {<br>&nbsp; &nbsp; req.<b>MaxTxBytes</b> -= <b>extInfoBzSize</b><br>}<br>"},{"parent":"1e8d6faea92b87d0","children":[],"id":"8b04bab5b01541ac","title":"// VE Tx太大无法打包到提案中<br><b>extInfoBz</b> = []byte{}<br>"}],"id":"1e8d6faea92b87d0","title":"// 调整 req.MaxTxBytes 以考虑 extInfoBzSize，<br>// 这样包装提案处理程序就不会从内存池中获取太多 tx<br><b>extInfoBzSize := int64(len(extInfoBz))</b><br>"},{"parent":"2cf90a050361d91e","children":[],"id":"af329f4d9b7c99f5","title":"// 构建提案，从mempool拉取普通的tx交易<br><b>resp</b> = h.<b>prepareProposalHandler</b>(<b>req</b>)<br>"},{"parent":"2cf90a050361d91e","children":[{"parent":"0f8a34311b33f2d6","children":[],"id":"d17945849534c923","title":"//VE Tx 尚未在 appTxs 中，首先注入投票扩展tx<br>if int64(len(<b>injectTx</b>)) &lt;= <b>maxSizeBytes</b> {<br>&nbsp; &nbsp; <b>consumedBytes</b> += <b>injectBytes</b><br>&nbsp; &nbsp; <b>returnedTxs</b> = append(returnedTxs, <b>injectTx</b>)<br>}<br>"},{"parent":"0f8a34311b33f2d6","children":[],"id":"b7fe9612e9b48e6b","title":"// 在给定 maxSizeBytes 约束的情况下，向返回的提案中添加尽可能多的 appTx<br>for _, tx := range <b>appTxs</b> {<br>&nbsp; &nbsp; consumedBytes += int64(len(tx))<br><br>&nbsp; &nbsp; if <b>consumedBytes</b> &gt; <b>maxSizeBytes</b> {return <b>returnedTxs</b>}<br><br>&nbsp; &nbsp; <b>returnedTxs</b> = append(<b>returnedTxs</b>, <b>tx</b>)<br>}<br>"},{"parent":"0f8a34311b33f2d6","children":[],"id":"25086f3397b976a2","title":"return <b>returnedTxs</b>"}],"id":"0f8a34311b33f2d6","title":"// 注入投票扩展Tx，并调整响应 Txs 的大小以遵守 req.MaxTxBytes<br>// 返回一个交易数组，该数组开头包含injectTx，后面跟着appTx。<br>// 返回的交易数组受maxSizeBytes限制，injectTx都只会出现一次。<br>//如果injectTx足够大，则所有originalTx最终都可能被排除在返回的交易数组之外。<br>resp.<b>Txs</b> = h.<b>injectAndResize</b>(resp.<b>Txs</b>, <b>extInfoBz</b>, req.<b>MaxTxBytes</b>+int64(len(<b>extInfoBz</b>)))<br>"},{"parent":"2cf90a050361d91e","children":[],"id":"e50ca91886c1c5ae","title":"return <b>resp</b>"}],"id":"2cf90a050361d91e","title":"// 首先用交易填充提案。<br>// 处理器将把扩展的提交信息注入提案。<br><b>PrepareProposalHandler</b>(req)<br>"},{"parent":"4d70d73dad33","children":[{"parent":"89de577bbfd2cf4c","children":[],"id":"32e818a5c7069909","title":"// req中获取第一笔交易即扩展投票交易<br><b>extCommitBz</b> := req.<b>Txs</b>[0]<br>"},{"parent":"89de577bbfd2cf4c","children":[],"id":"1d9beea9994cb6f0","title":"// 解析扩展投票交易<br><b>extInfo</b> = h.extendedCommitCodec.<b>Decode</b>(<b>extCommitBz</b>)<br>"},{"parent":"89de577bbfd2cf4c","children":[],"id":"85888c2194386b2e","title":"// 验证扩展投票交易<br>h.<b>ValidateExtendedCommitInfo</b>(req.<b>Height</b>, <b>extInfo</b>);<br>"},{"parent":"89de577bbfd2cf4c","children":[],"id":"551a04e9f80b39cf","title":"// 重置req.tx，只将appTx交给封装函数处理<br><b>req.Txs = req.Txs[0:]</b><br>"},{"parent":"89de577bbfd2cf4c","children":[],"id":"360ff556c1d97c31","title":"// 调用封装的提案处理handler<br><b>resp = h.processProposalHandler(req)</b><br>"},{"parent":"89de577bbfd2cf4c","children":[],"id":"313b8924af5f7448","title":"return <b>resp</b>"}],"id":"89de577bbfd2cf4c","title":"// 验证提案中包含的投票扩展是否有效，<b><br>ProcessProposalHandler</b>()<br>"}],"id":"4d70d73dad33","title":"<b>2、Proposals</b>"},{"parent":"812b3a9306dd","children":[{"parent":"ac25a09c6779","children":[{"parent":"b21482d303b38984","children":[],"id":"a1bbb605652f8de3","title":"// 负责从每个验证器聚合 oracle 数据，将 oracle 数据写入存储。<br>type <b>PreBlockHandler</b> struct {&nbsp;<br>&nbsp; &nbsp; <b>keeper</b> Keeper&nbsp;// 用于将 oracle 数据写入状态。<br>&nbsp; &nbsp; <b>voteExtensionCodec</b>&nbsp;// 用于编码/解码投票扩展的编解码器。这用于解码交易中包含的投票扩展。<br>&nbsp; &nbsp; <b>extendedCommitCodec</b>&nbsp;// 是用于编码/解码扩展提交消息的编解码器。这用于解码交易中包含的扩展提交消息。<br>&nbsp; &nbsp; <b>voteAggregator</b> voteaggregator.VoteAggregator&nbsp;// 负责将扩展提交中的投票聚合到规范价格中<br>}<br>"},{"parent":"b21482d303b38984","children":[{"parent":"949d329ba7b0f561","children":[],"id":"60939e8633d64236","title":"<b>// 构建一个默认的投票聚合器<br>va</b> := voteaggregator.<b>NewDefaultVoteAggregator</b>(aggregateFn,strategy,)<br>"},{"parent":"949d329ba7b0f561","children":[],"id":"971fb6b3fea1edf3","title":"return &amp;<b>PreBlockHandler</b>{<br><b>&nbsp; &nbsp; keeper</b>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; oracleKeeper,<br><b>&nbsp; &nbsp; voteExtensionCodec</b>:&nbsp; veCodec,<br><b>&nbsp; &nbsp; extendedCommitCodec</b>: ecCodec,<br><b>&nbsp; &nbsp; voteAggregator</b>:&nbsp; &nbsp; &nbsp; va,<br>}"}],"id":"949d329ba7b0f561","title":"// 构建OraclePreBlockHandler<b><br>NewOraclePreBlockHandler</b>()<br>"},{"parent":"b21482d303b38984","children":[{"parent":"f8719e7680181a30","children":[],"id":"cda641fcaa73f04e","title":"// 从req请求中获取oracle的扩展投票交易即第一笔交易。由<b>Aggregator</b>实现<br><b>votes</b> = voteaggregator.<b><font color=\"#e74f4c\">GetOracleVotes</font></b>(req.<b>Txs</b>)<br>"},{"parent":"f8719e7680181a30","children":[],"id":"e7b36dc1b71cb980","title":"// 将所有 oracle 投票扩展聚合为一组价格。由<b>Aggregator</b>实现<br><b>prices</b> = h.voteAggregator.<b><font color=\"#e74f4c\">AggregateOracleVotes</font></b>(<b>votes</b>)"},{"parent":"f8719e7680181a30","children":[{"parent":"3cbebf62253baf10","children":[],"id":"5eea744f9411c526","title":"// 获取Oracle模块的所有货币对<br><b>currencyPairs</b> := h.keeper.<b>GetAllCurrencyPairs</b>()<br>"},{"parent":"3cbebf62253baf10","children":[{"parent":"70842eab74e67018","children":[],"id":"c845e539da9df0f8","title":"最新价格<br><b>price</b>, ok := <b>prices</b>[cp]<br>"},{"parent":"70842eab74e67018","children":[],"id":"09d54fdfa7eb96d5","title":"// 将价格转换为报价。<br><b>quotePrice</b> := oracletypes.<b>QuotePrice</b>{<br>&nbsp; &nbsp; <b>Price</b>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; math.<b>NewIntFromBigInt</b>(<b>price</b>),<br>&nbsp; &nbsp; <b>BlockTimestamp</b>: ctx.BlockHeader().Time,<br>&nbsp; &nbsp; <b>BlockHeight</b>:&nbsp; &nbsp; uint64(ctx.BlockHeight()),<br>}<br>"},{"parent":"70842eab74e67018","children":[],"id":"ea051f4f97e3b3c9","title":"// 将报价写入状态。<br>h.keeper.<b><font color=\"#7bd144\">SetPriceForCurrencyPair</font></b>(<b>cp</b>, <b>quotePrice</b>)<br>"}],"id":"70842eab74e67018","title":"// 遍历所有货币对并更新最新的价格<br>for _, <b>cp</b> := range <b>currencyPairs</b> {<br><br>}<br>"}],"id":"3cbebf62253baf10","title":"// 将 oracle 数据写入oracleKeeper模块存储。<br>h.<b><font color=\"#7bd144\">WritePrices</font></b>(<b>prices</b>)"}],"id":"f8719e7680181a30","title":"// 聚合来自每个验证器的预言机数据并存储。<br><b>PreBlocker</b>(<b>req</b> *cometabci.RequestFinalizeBlock)<br>"}],"id":"b21482d303b38984","title":"<b>Oracle</b>"},{"parent":"ac25a09c6779","children":[{"parent":"c88bc2d11ac151c7","children":[],"id":"f1237192efb50dd6","title":"type PreBlockHandler struct {<br>&nbsp; &nbsp; <b>oracleKeeper</b>&nbsp; OracleKeeper<br>&nbsp; &nbsp; <b>stakingKeeper</b> StakingKeeper<br>&nbsp; &nbsp; <b>slaKeeper</b>&nbsp; &nbsp; &nbsp;Keeper<br>&nbsp; &nbsp; <b>currencyPairIDStrategy</b> // 用于生成/检索货币对 ID 的策略<br>}"},{"parent":"c88bc2d11ac151c7","children":[{"parent":"45573cde236b0dfd","children":[],"id":"56327028d67e991d","title":"// 检索区块中包含的所有投票扩展。这将返回验证者列表及其进行的价格更新。<br><b>votes</b> := voteaggregator.<b>GetOracleVotes</b>(req.Txs, h.voteExtensionCodec, h.extendedCommitCodec)<br>"},{"parent":"45573cde236b0dfd","children":[{"parent":"fb04ab7b4a374d58","children":[{"parent":"c57ac18f389d6a8e","children":[{"parent":"868d2db316b3b4a2","children":[],"id":"c464f1e462c30cf8","title":"<b>ValidatorUpdate</b> struct {<br><b>ConsAddress</b> sdk.ConsAddress<br><b>Updates</b> map[slinkytypes.<b>CurrencyPair</b>]slatypes.<b>UpdateStatus</b><br>}"}],"id":"868d2db316b3b4a2","title":"// 更新的验证节点或者货币对<br>return <b>PriceFeedUpdates</b>{<br>&nbsp; &nbsp; <b>ValidatorUpdates</b>: make(map[string]ValidatorUpdate),<br>&nbsp; &nbsp; <b>CurrencyPairs</b>:&nbsp; &nbsp; make(map[slinkytypes.CurrencyPair]struct{}),<br>}<br>"}],"id":"c57ac18f389d6a8e","title":"// 构建一个新的更新列表<br>updates := slakeeper.<b>NewPriceFeedUpdates</b>()<br>"},{"parent":"fb04ab7b4a374d58","children":[],"id":"76d73b42f39abb4e","title":"// 获取当前绑定的验证节点<br><b>bondedValidators</b> := h.stakingKeeper.<b>GetBondedValidatorsByPower</b>(ctx)<br>"},{"parent":"fb04ab7b4a374d58","children":[],"id":"fa35421bdbc67ab1","title":"// 过滤出预言机支持的货币对<br><b>currencyPairs</b> := h.oracleKeeper.<b>GetAllCurrencyPairs</b>(ctx)<br>for _, cp := range currencyPairs {<b>updates</b>.<b><font color=\"#000000\">CurrencyPairs</font></b>[cp] = struct{}{}}<br>"},{"parent":"fb04ab7b4a374d58","children":[{"parent":"ab3123c924e8c9b7","children":[],"id":"d7c82c5032567b35","title":"// 将每个货币对的状态初始化为NoVote。<br><b>validator</b> := slakeeper.<b>NewValidatorUpdate</b>(consAddress)<br>for _, cp := range <b><font color=\"#7bd144\">currencyPairs</font></b> {validator.<b>Updates</b>[cp] = slatypes.<b>NoVote</b>}"},{"parent":"ab3123c924e8c9b7","children":[],"id":"e04cf67cc2c9cb52","title":"updates.<b><font color=\"#7bd144\">ValidatorUpdates</font></b>[consAddress.String()] = <b>validator</b>"}],"id":"ab3123c924e8c9b7","title":"// 为每个绑定的验证者初始化一个空状态。<br>// 每个验证节点对每个货币对投空票NoVote<br>for _, validator := range bondedValidators {<br><br>}<br>"},{"parent":"fb04ab7b4a374d58","children":[{"parent":"d3f712f89a4c5ef4","children":[{"parent":"7a1cdf6764aa11b6","children":[{"parent":"8eb0223759f06d40","children":[],"id":"3057ff39f1c7523f","title":"id := currencyPairIDStrategy.ID(ctx, cp)"},{"parent":"8eb0223759f06d40","children":[],"id":"c32d268349cb7717","title":"if _, ok := <b><font color=\"#4669ea\">prices</font></b>[id]; !ok {<b>validatorUpdates</b>[cp] = slatypes.<b>VoteWithoutPrice</b>}&nbsp;"},{"parent":"8eb0223759f06d40","children":[],"id":"ca1196c2ee3db738","title":"else {<b>validatorUpdates</b>[cp] = slatypes.<b>VoteWithPrice</b>}<br>"}],"id":"8eb0223759f06d40","title":"// 遍历预言机支持的货币对<br>for cp := range <b><font color=\"#e74f4c\">currencyPairs</font></b> {<br>&nbsp;&nbsp;<br>}<br>"}],"id":"7a1cdf6764aa11b6","title":"// 对比预言机的货币对和投票扩展的货币对：匹配状态=VoteWithPrice<br>// 标记本验证节点对那些货币对投票了。<br><b>valUpdates</b> := <b>getStatuses</b>(<b><font color=\"#e74f4c\">currencyPairs</font></b>, vote.OracleVoteExtension.<b><font color=\"#4669ea\">Prices</font></b>)<br>"},{"parent":"d3f712f89a4c5ef4","children":[],"id":"aa2b62ccad0bede1","title":"// 更新本验证节点对于货币对的投票信息<br><b>validator</b> := updates.<b><font color=\"#7bd144\">ValidatorUpdates</font></b>[<b>vote</b>.ConsAddress.String()]<br>validator.Updates = <b>valUpdates</b><br>updates.ValidatorUpdates[<b>vote</b>.ConsAddress.String()] = validator<br>"}],"id":"d3f712f89a4c5ef4","title":"//&nbsp;获取每个验证者对price价格投票的状态。<br>for _, vote := range votes {<br>&nbsp; &nbsp;&nbsp;<br>&nbsp; &nbsp;&nbsp;<br>}"}],"id":"fb04ab7b4a374d58","title":"// 为每个验证器创建按状态更新价格的映射。<br><b>updates</b> := h.<b>GetUpdates</b>(<b>votes</b>)"},{"parent":"45573cde236b0dfd","children":[],"id":"90634ef868a035b9","title":"// 更新每个验证器的所有价格信息。<br>h.slaKeeper.<b><font color=\"#e855a4\">UpdatePriceFeeds</font></b>(<b>updates</b>)"}],"id":"45573cde236b0dfd","title":"<b>PreBlocker</b>()"}],"id":"c88bc2d11ac151c7","title":"<b>SLA</b>"}],"id":"ac25a09c6779","title":"<b>// 解析提案的第一笔即预言机投票交易<br>// 然后根据指定的策略聚合所有Price交易<br>// 将最终的结果写入Oracle模块状态供使用<br>3、Preblock</b><br>"},{"parent":"812b3a9306dd","children":[{"parent":"cc3ed3b6c1a9747c","children":[],"id":"b14251641f83d8c6","title":"type <b>VoteExtensionHandler</b> struct {<br><b>&nbsp; &nbsp; oracleClient</b> client.OracleClient&nbsp;// 负责获取价格的远程预言机客户端<br><b>&nbsp; &nbsp; currencyPairStrategy</b> currencypair.CurrencyPairStrategy&nbsp;// 用于确定要包含在投票扩展中的价格信息的策略。<br><b>&nbsp; &nbsp; preBlocker</b> sdk.PreBlocker// 用于更新和检索最新的链上价格信息。<br>}"},{"parent":"cc3ed3b6c1a9747c","children":[{"parent":"b10e541371c27682","children":[],"id":"1c7a5ba5da332723","title":"return &amp;VoteExtensionHandler{<br>logger:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;logger,<br>oracleClient:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;oracleClient,<br>timeout:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; timeout,<br>currencyPairStrategy: strategy,<br>voteExtensionCodec:&nbsp; &nbsp;codec,<br>preBlocker:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;preBlocker,<br>metrics:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; metrics,<br>}"}],"id":"b10e541371c27682","title":"<b>NewVoteExtensionHandler</b>(<br>&nbsp; &nbsp; <b>oracleClient</b> client.OracleClient,<br>&nbsp; &nbsp; <b>strategy</b> currencypair.CurrencyPairStrategy,<br>&nbsp; &nbsp; <b>preBlocker</b> sdk.PreBlocker,<br>)"},{"parent":"cc3ed3b6c1a9747c","children":[{"parent":"16d9800420842ce8","children":[],"id":"06518394661d5ef2","title":"/ 使用当前区块提案中包含的投票扩展来更新最新的链上价格。<br><b>reqFinalizeBlock</b> := &amp;cometabci.<b>RequestFinalizeBlock</b>{<b>Txs</b>: req.Txs,Height: req.Height,}<br>h.<b>preBlocker</b>(<b>reqFinalizeBlock</b>)<br>"},{"parent":"16d9800420842ce8","children":[],"id":"d319845bcb0fca6d","title":"// 获取预言机客户端提供的最新价格<br><b>oracleResp</b> := h.<b>oracleClient</b>.<b>Prices</b>(&amp;servicetypes.QueryPricesRequest{})<br>"},{"parent":"16d9800420842ce8","children":[],"id":"cbc6cfeea01d5b5f","title":"// 将响应价格转换为投票扩展并编码。<br><b>voteExt</b> := h.<b>transformOracleServicePrices</b>(oracleResp.Prices)<br><b>bz</b>, := h.voteExtensionCodec.<b>Encode</b>(<b>voteExt</b>)<br>"},{"parent":"16d9800420842ce8","children":[],"id":"467c333644e035dc","title":"// 返回投票扩展的信息<br>return &amp;cometabci.<b>ResponseExtendVote</b>{<b>VoteExtension</b>: <b>bz</b>}<br>"}],"id":"16d9800420842ce8","title":"// 获取投票扩展的信息<br><b>ExtendVoteHandler</b>()<br>"},{"parent":"cc3ed3b6c1a9747c","children":[{"parent":"4bedbdf5fe128c0e","children":[],"id":"1f411f5a7966383a","title":"// 解码投票扩展字节<br><b>voteExtension</b> := h.voteExtensionCodec.<b>Decode</b>(req.VoteExtension)"},{"parent":"4bedbdf5fe128c0e","children":[{"parent":"be4a8d3e40843dc7","children":[],"id":"2c8db7c2a26ba700","title":"// 验证价格是否有效。<br>for id, bz := range ve.<b>Prices</b> {<br>&nbsp; &nbsp;&nbsp;cp := strategy.FromID(id)<br>&nbsp; &nbsp;&nbsp;strategy.GetDecodedPrice( cp, bz)<br>}<br>"}],"id":"be4a8d3e40843dc7","title":"// 根据货币对策略验证预言机投票扩展信息<br><b>ValidateOracleVoteExtension</b>(voteExtension, h.currencyPairStrategy)<br>"},{"parent":"4bedbdf5fe128c0e","children":[],"id":"0397b62e584b0c7f","title":"return &amp;cometabci.ResponseVerifyVoteExtension{Status: cometabci.<b><font color=\"#7bd144\">ResponseVerifyVoteExtension_ACCEPT</font></b>}"}],"id":"4bedbdf5fe128c0e","title":"<b>VerifyVoteExtensionHandler</b>()"}],"id":"cc3ed3b6c1a9747c","title":"// 使用预言机当前价格反馈扩展投票的处理程序。<b><br>4、VoteExtensionHandler</b><br>"},{"parent":"812b3a9306dd","children":[{"parent":"262544e51f5bac27","children":[{"parent":"17d2dc1a2cdc983b","children":[{"parent":"3f76aa67daad56c8","children":[],"id":"af4b18c3118fdacb","title":"// 价格定义了id(CurrencyPair) -&gt; price.Bytes() 的映射。<br>type <b>OracleVoteExtension</b> struct {<b>Prices</b> map[uint64][]byte&nbsp;}<br>"}],"id":"3f76aa67daad56c8","title":"type <b>Vote</b> struct {<br>&nbsp; &nbsp; <b>ConsAddress</b> sdk.ConsAddress<br>&nbsp; &nbsp; <b>OracleVoteExtension</b> vetypes.OracleVoteExtension<br>}"},{"parent":"17d2dc1a2cdc983b","children":[{"parent":"ca7d9be8838f85da","children":[{"parent":"67b58030d9610b59","children":[],"id":"1525877fdaea5d67","title":"type <b>ExtendedCommitInfo</b> struct {<br>&nbsp; &nbsp; <b>Round</b> int32&nbsp;<br>&nbsp; &nbsp; <b>Votes</b> []ExtendedVoteInfo&nbsp;<br>}"}],"id":"67b58030d9610b59","title":"// 解析提案的第一笔投票扩展交易<br><b>extendedCommitInfo</b> := extCommitCodec.Decode(proposal[0])<br>"},{"parent":"ca7d9be8838f85da","children":[{"parent":"c9f63dba6ef72a76","children":[],"id":"a7a0b24bc236b417","title":"// 解析每个投票扩展<br><b>voteExtension</b>&nbsp;:= veCodec.<b>Decode</b>(voteInfo.<b>VoteExtension</b>)<br>"},{"parent":"c9f63dba6ef72a76","children":[],"id":"931eb39ae12df17a","title":"// 解析每个投票的验证器地址<br><b>address</b> := sdk.ConsAddress{}<br>address.Unmarshal(<b>voteInfo</b>.<b>Validator</b>.<b>Address</b>)<br>"},{"parent":"c9f63dba6ef72a76","children":[],"id":"1f08cfd9b4ed870f","title":"// 构建投票扩展信息<br><b>votes</b>[i] = <b>Vote</b>{<b>ConsAddress</b>:&nbsp; address,<b>OracleVoteExtension</b>: <b>voteExtension</b>,}<br>"}],"id":"c9f63dba6ef72a76","title":"// 遍历所有投票扩展信息并构建Votes数组<br>for i, <b>voteInfo</b> := range extendedCommitInfo.<b>Votes</b> {<br><br>}<br>"}],"id":"ca7d9be8838f85da","title":"<b>// 从block提案中获取</b>OracleVotes信息<br><b>// 即block的第一笔交易index=0<br><font color=\"#e74f4c\">GetOracleVotes</font></b>(proposal [][]byte)<br>"}],"id":"17d2dc1a2cdc983b","title":"// 投票扩展结构体<br><b>OracleVotes</b><br>"},{"parent":"262544e51f5bac27","children":[{"parent":"e7c4460b0994b8d7","children":[{"parent":"db0cba0726d096d0","children":[],"id":"9c08f8d07a02a0ee","title":"<b>VoteAggregator</b> interface {<br><b>&nbsp; &nbsp; AggregateOracleVotes</b>( votes []Vote) (map[slinkytypes.CurrencyPair]*big.Int, error)<br><b>&nbsp; &nbsp; GetPriceForValidator</b>(validator sdk.ConsAddress) map[slinkytypes.CurrencyPair]*big.Int<br>}"},{"parent":"db0cba0726d096d0","children":[],"id":"eb4aa6af79738ddf","title":"type <b>DefaultVoteAggregator</b> struct {<br>&nbsp; &nbsp; // 记录验证器地址 -&gt; 货币对 -&gt; 价格<br><b>&nbsp; &nbsp; priceAggregator</b> *aggregator.<b><font color=\"#a23735\">DataAggregator</font></b>[string, map[slinkytypes.CurrencyPair]*big.Int]<br><br>&nbsp; &nbsp; // 解码价格 / 货币对 ID<br><b>&nbsp; &nbsp; currencyPairStrategy</b> currencypair.CurrencyPairStrategy<br>}"},{"parent":"db0cba0726d096d0","children":[],"id":"887ea4d03f703ec5","title":"// 聚合函数：按照验证节点power计算投票权重<br><b><font color=\"#f19594\">aggregatorFn</font></b> := <b>voteweighted</b>.<b>MedianFromContext</b>(app.StakingKeeper,voteweighted.DefaultPowerThreshold,)<br>"},{"parent":"db0cba0726d096d0","children":[{"parent":"a059bab9f93acf29","children":[],"id":"2a3b3160478a9003","title":"// 默认投票聚合器<br>return &amp;<b>DefaultVoteAggregator</b>{<br>&nbsp; &nbsp; <b>priceAggregator</b>: aggregator.<b><font color=\"#a23735\">NewDataAggregator</font></b>(aggregator.WithAggregateFnFromContext(<b><font color=\"#f19594\">aggregateFn</font></b>),),<br>&nbsp; &nbsp; <b>currencyPairStrategy</b>: strategy,<br>}<br>"}],"id":"a059bab9f93acf29","title":"<b>NewDefaultVoteAggregator</b>(<br>&nbsp; &nbsp; <b><font color=\"#f19594\">aggregateFn</font></b> aggregator.AggregateFnFromContext[string, map[slinkytypes.CurrencyPair]*big.Int],<br>&nbsp; &nbsp; <b>strategy</b> currencypair.CurrencyPairStrategy,<br>)"}],"id":"db0cba0726d096d0","title":"<b>VoteAggregator结构定义</b>"},{"parent":"e7c4460b0994b8d7","children":[{"parent":"4d918141905cbe6a","children":[{"parent":"1c19fcb9f7f0f915","children":[{"parent":"2e9df993e7378e1e","children":[{"parent":"f232fd4cc8a4433b","children":[],"id":"64ac02c55da17411","title":"<b>CurrencyPair</b> {<br>&nbsp; &nbsp; &nbsp; string <b>Base</b> = 1;<br>&nbsp; &nbsp; &nbsp; string <b>Quote</b> = 2;<br>}<br>"}],"id":"f232fd4cc8a4433b","title":"// 将资产转换为货币对。货币对在x/oracle模块申请<br><b>cp</b> := dva.currencyPairStrategy.<b>FromID</b>(cpID)"},{"parent":"2e9df993e7378e1e","children":[],"id":"a88b490a108972a7","title":"// 解码prices货币对的价格<br><b>price</b> := dva.currencyPairStrategy.<b>GetDecodedPrice</b>(<b>cp</b>, <b>priceBz</b>)<br>"},{"parent":"2e9df993e7378e1e","children":[],"id":"ea7ebe1c04815f2c","title":"// 构建prices货币对：atom/usdt=8<br><b>prices[cp] = price</b><br>"}],"id":"2e9df993e7378e1e","title":"// 遍历本验证者节点提供的所有prices<br>for <b>cpID</b>, <b>priceBz</b> := range oracleData.<b>Prices</b> {<br>&nbsp; &nbsp;&nbsp;<br>}<br>"},{"parent":"1c19fcb9f7f0f915","children":[{"parent":"fd324390beac12d0","children":[],"id":"3060a4b9c7862ccd","title":"p.<b><font color=\"#a23735\">providerData</font></b>[<b>provider</b>] = <b><font color=\"#a23735\">data</font></b>"}],"id":"fd324390beac12d0","title":"// 记录验证节点提供的货币对价格<br>dva.priceAggregator.<b><font color=\"#a23735\">SetProviderData</font></b>(address, prices)<br>"}],"id":"1c19fcb9f7f0f915","title":"// 遍历所有投票扩展，整合所有价格信息。<br>for _, <b>vote</b> := range <b>votes</b> {<br>&nbsp; &nbsp;&nbsp;<b>consAddrStr</b> := vote.ConsAddress.String()<br>&nbsp; &nbsp;&nbsp;dva.<b><font color=\"#e74f4c\">addVoteToAggregator</font></b>(<b>consAddrStr</b>, vote.<b>OracleVoteExtension</b>)<br>}<br>"},{"parent":"4d918141905cbe6a","children":[{"parent":"f227ea8233e3fbfc","children":[],"id":"7cdba2f2b40a71a1","title":"// 获取设置的聚合函数<br><b>aggregateFn</b> := p.<b>aggregateFnFromContext</b>(ctx)<br>"},{"parent":"f227ea8233e3fbfc","children":[],"id":"f5dfdcdfc69674e4","title":"// 获取需要聚合的数据<br><b>providerData</b> := p.<b><font color=\"#a23735\">GetProviderData</font></b>()<br>"},{"parent":"f227ea8233e3fbfc","children":[],"id":"d6735a524f7161ed","title":"// 聚合数据并存储到全局变量中：<b><font color=\"#ec7270\">voteweighted</font></b>实现<br>p.<b><font color=\"#ec7270\">SetAggregatedData</font></b>(aggregateFn(providerData))<br>"}],"id":"f227ea8233e3fbfc","title":"// 计算每个货币对的最终价格。<br>dva.priceAggregator.<b><font color=\"#a23735\">AggregateDataFromContext</font></b>()<br>"},{"parent":"4d918141905cbe6a","children":[],"id":"3c1702335dd70021","title":"// 获取最终聚合的prices：<b><font color=\"#ec7270\">voteweighted</font></b>实现<br><b><font color=\"#ec7270\">prices</font></b> := dva.priceAggregator.<b><font color=\"#ec7270\">GetAggregatedData</font></b>()<br>"},{"parent":"4d918141905cbe6a","children":[],"id":"e7c06146c68b1ecc","title":"return <b><font color=\"#ec7270\">prices</font></b>"}],"id":"4d918141905cbe6a","title":"<font color=\"#000000\">// 按照设置的侧率聚合预言机投票prices</font><br><b>AggregateOracleVotes</b>(votes []Vote)<br>"}],"id":"e7c4460b0994b8d7","title":"<b>// 投票聚合器<br>VoteAggregator</b><br>"},{"parent":"262544e51f5bac27","children":[{"parent":"b78913dc1e5b7413","children":[{"parent":"3b84383b2fbf8e32","children":[],"id":"9fbbbb86d8832574","title":"// 定义包含验证者权益权重的价格更新。<br><b>PricePerValidator</b> struct {<br>&nbsp; &nbsp; <b>VoteWeight</b> math.Int<br>&nbsp; &nbsp; <b>Price</b>&nbsp; &nbsp; &nbsp; *big.Int<br>}"}],"id":"3b84383b2fbf8e32","title":"// 针对指定货币对的价格以及总的投票权重<br><b>PriceInfo</b> struct {<br>&nbsp; &nbsp; <b>Prices</b>&nbsp; &nbsp; &nbsp; []<b>PricePerValidator</b><br>&nbsp; &nbsp; <b>TotalWeight</b> math.Int<br>}<br>"},{"parent":"b78913dc1e5b7413","children":[{"parent":"5e46489e5e3375d3","children":[{"parent":"86d9cf9fd6a0bd77","children":[],"id":"ad061d08335db759","title":"// 获取验证节点的power权重<br><b>address</b> := sdk.ConsAddressFromBech32(<b>valAddress</b>)<br><b>validator</b> := validatorStore.ValidatorByConsAddr(&nbsp;<b>address</b>)<br><b>voteWeight</b> := validator.<b>GetBondedTokens</b>()<br>"},{"parent":"86d9cf9fd6a0bd77","children":[{"parent":"69357a40739485a7","children":[],"id":"c9aea9036473665b","title":"// 更新货币对的价格信息。<br>cpInfo := <b>priceInfo</b>[currencyPair]<br>priceInfo[currencyPair] = PriceInfo{<br>&nbsp; &nbsp; <b>Prices</b>: append(cpInfo.<b>Prices</b>, <b>PricePerValidator</b>{<b>VoteWeight</b>: voteWeight,<b>Price</b>:&nbsp; price,}),<br>&nbsp; &nbsp; <b>TotalWeight</b>: <b>cpInfo</b>.TotalWeight.Add(<b>voteWeight</b>),<br>}"}],"id":"69357a40739485a7","title":"// 遍历所有价格并存储每个货币对的价格 + 投票权重。<br>for <b>currencyPair</b>, <b>price</b> := range <b>validatorPrices</b> {}"}],"id":"86d9cf9fd6a0bd77","title":"// 遍历所有提供商并存储每个货币对的股权权重 + 价格。<br>for <b>valAddress</b>, <b>validatorPrices</b> := range <b>providers</b> {<br><br>}<br>"},{"parent":"5e46489e5e3375d3","children":[],"id":"7039f1cabcc567df","title":"// 获取整个网络绑定的总power值。<br><b>totalBondedTokens</b> := validatorStore.<b>TotalBondedTokens</b>()"},{"parent":"5e46489e5e3375d3","children":[{"parent":"4c18b2274cbfb8f4","children":[],"id":"123d279236813160","title":"// 计算货币对的总投票power是否满足设置的2/3的门限<br>info.<b>TotalWeight</b> / <b>totalBondedTokens</b> &gt;=&nbsp;<b>threshold</b><br>"},{"parent":"4c18b2274cbfb8f4","children":[{"parent":"3f530e51165b6ec0","children":[],"id":"721a83fa1ccada80","title":"// 首先通过价格排序<br>sort.SliceStable(priceInfo.Prices, func(i, j int)<br>"},{"parent":"3f530e51165b6ec0","children":[],"id":"7defbfdf14f6ded8","title":"// 计算中位数权重。<br><b>middle</b> := priceInfo.<b>TotalWeight /&nbsp;</b>2"},{"parent":"3f530e51165b6ec0","children":[{"parent":"13cb33d37b0a84d3","children":[],"id":"1aa29050bb9c6478","title":"// 找到权重中间的price<br><b>sum</b> = <b>sum</b>.Add(price.<b>VoteWeight</b>)<br>if <b>sum</b>.GTE(<b>middle</b>) {return price.<b>Price</b>}<br>"},{"parent":"13cb33d37b0a84d3","children":[],"id":"022dc2c4f1a7bbf6","title":"if index == len(priceInfo.Prices)-1 {return price.Price}"}],"id":"13cb33d37b0a84d3","title":"// 遍历价格并计算中间价格。<br>for index, <b>price</b> := range priceInfo.<b>Prices</b> {<br><br>}<br>"}],"id":"3f530e51165b6ec0","title":"// 计算货币对的最终中间价格<br><b>prices</b>[<b>currencyPair</b>] = <b>ComputeMedian</b>(<b>info</b>)<br>"}],"id":"4c18b2274cbfb8f4","title":"// 遍历所有价格并计算每个资产的中间价格。<br>for <b>currencyPair</b>, <b>info</b> := range <b>priceInfo</b> {<br><br>}<br>"},{"parent":"5e46489e5e3375d3","children":[],"id":"6c200ebe4e6beff7","title":"return <b>prices</b>"}],"id":"5e46489e5e3375d3","title":"// 中间价格策略聚合函数<br><b>Median</b>(<b>validatorStore</b>,<b>threshold</b>)<br>"}],"id":"b78913dc1e5b7413","title":"实例：基于power权重的中间价聚合器<br><b>voteweighted</b><br>"}],"id":"262544e51f5bac27","title":"聚合器策略<br><b>Aggregator-Strategies</b><br>"}],"id":"812b3a9306dd","title":"ABCI"},{"parent":"root","lineStyle":{"randomLineColor":"#7549C5"},"children":[{"parent":"9a62d8eb7001854f","children":[{"parent":"8d3dca3f45712172","children":[{"parent":"8bb057c56ed9de87","children":[{"parent":"e196863421dc4d33","children":[],"id":"1f72f0e79858e17a","title":"<b>CurrencyPair</b> {<br>&nbsp; Base string;<br>&nbsp; Quote string;<br>}"}],"id":"e196863421dc4d33","title":"type GetPriceRequest struct {<br>&nbsp; &nbsp; <b>CurrencyPair</b> types.CurrencyPair&nbsp;<br>}"},{"parent":"8bb057c56ed9de87","children":[{"parent":"e0168902fd3939a7","children":[],"id":"38b1fc8f4eebee6a","title":"// 获取给定 CurrencyPair 的 QuotePrice + nonce<br><b>qpn</b> := q.k.<b>GetPriceWithNonceForCurrencyPair</b>(cp)"},{"parent":"e0168902fd3939a7","children":[],"id":"7f7b23ae3c287219","title":"// 获取货币对的唯一id<br><b>id</b> := q.k.<b>GetIDForCurrencyPair</b>(cp)<br>"},{"parent":"e0168902fd3939a7","children":[{"parent":"47d632ecd2c6ffda","children":[],"id":"68554a2abf819925","title":"<b>ticker</b> := k.mmKeeper.<b>GetTicker</b>( cp.String())"},{"parent":"47d632ecd2c6ffda","children":[],"id":"64a25d6a1c3dcc81","title":"return <b>ticker</b>.<b>Decimals</b>"}],"id":"47d632ecd2c6ffda","title":"// 获取货币对的精度，通过x/marketmap模块<br><b>decimals</b> := q.k.<b>GetDecimalsForCurrencyPair</b>(cp)<br>"},{"parent":"e0168902fd3939a7","children":[],"id":"c44eab2244542eac","title":"//返回 QuotePrice + Nonce<br>return &amp;types.<b>GetPriceResponse</b>{<br>&nbsp; &nbsp; <b>Price</b>:&nbsp; &nbsp; &amp;qpn.QuotePrice,<br>&nbsp; &nbsp; <b>Nonce</b>:&nbsp; &nbsp; qpn.Nonce(),<br>&nbsp; &nbsp; <b>Decimals</b>: decimals,<br>&nbsp; &nbsp; <b>Id</b>:&nbsp; &nbsp; &nbsp; &nbsp;id,<br>},"}],"id":"e0168902fd3939a7","title":"<b>GetPrice</b>(req *types.GetPriceRequest)"}],"id":"8bb057c56ed9de87","title":"// 获取指定交易对的当前价格<br>GetPriceCmd(),<br>"},{"parent":"8d3dca3f45712172","children":[{"parent":"3629afb27247c5a8","children":[],"id":"a4513802c24e576a","title":"GetAllCurrencyPairs(types.GetAllCurrencyPairsRequest)"}],"id":"3629afb27247c5a8","title":"GetAllCurrencyPairsCmd(),"}],"id":"8d3dca3f45712172","title":"Query"},{"parent":"9a62d8eb7001854f","children":[{"parent":"32195b0c9f62e69f","children":[],"id":"e3751f2e65792c57","title":"Keeper struct {<br><b>mmKeeper</b> types.MarketMapKeeper<br><br>// schema<br>nextCurrencyPairID collections.Sequence<br>currencyPairs&nbsp; &nbsp; &nbsp; *collections.IndexedMap[string, types.CurrencyPairState, *oracleIndices]<br>schema&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;collections.Schema<br><br>// indexes<br>idIndex *indexes.Multi[uint64, string, types.CurrencyPairState]<br><br>// module authority<br>authority sdk.AccAddress<br>}"}],"id":"32195b0c9f62e69f","title":"Kepper"},{"parent":"9a62d8eb7001854f","children":[{"parent":"aa86680499d8a037","children":[],"id":"ac34a34156abd564","title":"// 货币对不存在需要创建，分配一个唯一id<br><b>id</b> := k.<b>nextCurrencyPairID</b>.Next(ctx)<br><b>cps</b> = types.<b>NewCurrencyPairState</b>(id, 0, &amp;qp)<br>"},{"parent":"aa86680499d8a037","children":[],"id":"c3ef4663aa01f90f","title":"// 更新已存在的货币对，nonce自增<br><b>cps.Nonce++<br>cps.Price = &amp;qp</b><br>"},{"parent":"aa86680499d8a037","children":[],"id":"42b872ed824dfa75","title":"// 更新状态<br>k.<b>currencyPairs</b>.<b>Set</b>(<b>cp</b>.String(), <b>cps</b>)<br>"}],"id":"aa86680499d8a037","title":"// 提供给VoteExtensionHandler时更新最新price<br>Keeper.<b><font color=\"#7bd144\">SetPriceForCurrencyPair</font></b>()<br>"},{"parent":"9a62d8eb7001854f","children":[{"parent":"890b367b21b0706d","children":[],"id":"c907262860ec0190","title":"// 消息权限校验<br>req.Authority == m.k.authority.String()&nbsp;<br>"},{"parent":"890b367b21b0706d","children":[],"id":"d5de834d71ac8374","title":"// 构建新的货币对<br>for _, cp := range req.<b>CurrencyPairs</b> {<br>&nbsp; &nbsp; &nbsp;m.k.<b>CreateCurrencyPair</b>(ctx, cp)<br>}<br>"}],"id":"890b367b21b0706d","title":"// 未使能mmKeeper时通过治理添加货币对<br><b><font color=\"#e74f4c\">AddCurrencyPairs</font></b>(req *types.MsgAddCurrencyPairs)<br>"},{"parent":"9a62d8eb7001854f","children":[{"parent":"8aae3bff7fdb2a35","children":[],"id":"bbd58fc9572824b5","title":"// 消息权限校验<br>req.Authority == m.k.authority.String()"},{"parent":"8aae3bff7fdb2a35","children":[],"id":"51e206452c79034a","title":"// 删除指定的货币对<br>for _, id := range req.<b>CurrencyPairIds</b> {<br>&nbsp; &nbsp; cp := slinkytypes.CurrencyPairFromString(id)<br>&nbsp; &nbsp; m.k.<b>RemoveCurrencyPair</b>(cp)<br>}<br>"}],"id":"8aae3bff7fdb2a35","title":"// 未使能mmKeeper时通过治理提案删除货币对<br><b><font color=\"#e74f4c\">RemoveCurrencyPairs</font></b>(req *types.MsgRemoveCurrencyPairs)<br>"},{"parent":"9a62d8eb7001854f","children":[{"parent":"e791c12dc6bb944f","children":[],"id":"51edfa8d419b3360","title":"<b><font color=\"#4669ea\">AfterMarketCreated</font></b>(ticker marketmaptypes.Ticker) error {<br>&nbsp; &nbsp; return h.k.<b><font color=\"#4669ea\">CreateCurrencyPair</font></b>(ctx, ticker.CurrencyPair)<br>}"},{"parent":"e791c12dc6bb944f","children":[],"id":"34a5eb1b2e862954","title":"<b><font color=\"#000000\">// 校验创世配置指定的货币对都已经创建</font><br><font color=\"#4669ea\">AfterMarketGenesis</font></b>(tickers map[string]marketmaptypes.Ticker){<br>&nbsp; &nbsp; for _, ticker := range tickers {<br>&nbsp; &nbsp; &nbsp; &nbsp; h.k.<b>HasCurrencyPair</b>(ctx, ticker.CurrencyPair)&nbsp;<br>}<br>"}],"id":"e791c12dc6bb944f","title":"// marketmap模块的钩子函数<br><b><font color=\"#4669ea\">Hooks</font></b><br>"}],"id":"9a62d8eb7001854f","title":"x/oracle"},{"parent":"root","lineStyle":{"lineColor":"#0F80C4","randomLineColor":"#0F80C4","lineWidth":3},"children":[{"parent":"a0816a897a340cbf","children":[{"parent":"693b041258fd2e4c","children":[],"id":"af23a0c162f04761","title":"type <b>Keeper</b> struct {<br><b>slas</b>&nbsp;// slas 是 (sla ID -&gt; SLA) 的映射，用于跟踪当前处于 x/sla 模块状态的 SLA。<br><b>priceFeeds</b> // priceFeeds 是 (sla ID，货币对，共识地址 -&gt; 价格反馈) 的映射<br><b>currencyPairs</b> collections.Map[string, slinkytypes.CurrencyPair]<br><b>params</b> collections.Item[slatypes.Params]<br><b>authority</b> sdk.AccAddress<br><b>stakingKeeper</b> slatypes.StakingKeeper<br><b>slashingKeeper</b> slatypes.SlashingKeeper<br>}"}],"id":"693b041258fd2e4c","title":"keeper"},{"parent":"a0816a897a340cbf","children":[{"parent":"4e19468bf4ee5be6","children":[{"parent":"439f990cdef04ff7","children":[{"parent":"cfb9de428a2a3760","children":[],"id":"e9cdd0a760d88409","title":"type <b>PriceFeedSLA</b> struct {<br>&nbsp; &nbsp; <b>MaximumViableWindow</b> uint64&nbsp;<br>&nbsp; &nbsp; <b>ExpectedUptime</b> // 预期的正常喂价时间&nbsp;<br>&nbsp; &nbsp; <b>SlashConstant</b>&nbsp; // 与预期正常运行时间的偏差乘以的常数，用于惩罚。&nbsp;<br>&nbsp; &nbsp; <b>MinimumBlockUpdates</b> // 是验证者必须在最大可行窗口中投票的最小块数，以便考虑 SLA。&nbsp;<br>&nbsp; &nbsp; <b>Frequency</b> // 检查SLA的频率&nbsp;<br>&nbsp; &nbsp; <b>ID</b> string&nbsp;<br>}<br>"}],"id":"cfb9de428a2a3760","title":"type MsgAddSLAs struct {<br>&nbsp; &nbsp; <b>SLAs</b> []PriceFeedSLA&nbsp;<br>&nbsp; &nbsp; <b>Authority</b> string&nbsp;<br>}"},{"parent":"439f990cdef04ff7","children":[{"parent":"ff29e209ef1ec73d","children":[],"id":"ab096538cc75988f","title":"k.slas.<b>Set</b>(sla.ID, sla)"}],"id":"ff29e209ef1ec73d","title":"for _, sla := range slas {<br>&nbsp; &nbsp; k.<b>SetSLA</b>(sla);&nbsp;<br>}<br>"}],"id":"439f990cdef04ff7","title":"<b>// 通过共识添加一个服务水平协议<br>AddSLAs</b>(req *slatypes.MsgAddSLAs)<br>"},{"parent":"4e19468bf4ee5be6","children":[{"parent":"0356c575e8650b04","children":[],"id":"7a9f2c385fe5fe1b","title":"for _, id := range <b>req.IDs</b> {<br>&nbsp; &nbsp; m.k.<b>RemovePriceFeedsBySLA</b>(id);&nbsp;<br>&nbsp; &nbsp; m.k.<b>RemoveSLA</b>(id);&nbsp;<br>}"}],"id":"0356c575e8650b04","title":"<b>RemoveSLAs</b>(req *slatypes.MsgRemoveSLAs)"},{"parent":"4e19468bf4ee5be6","children":[{"parent":"ef05842ffd81594a","children":[],"id":"31706e5b28701117","title":"<b>// 获取所有服务水平标准<br>slas</b> := k.<b>GetSLAs</b>()<br>"},{"parent":"ef05842ffd81594a","children":[],"id":"3800513a5878aff2","title":"// 获取本模块存储的货币对<br><b>cpsToRemove</b> := k.<b>GetCurrencyPairs</b>(ctx)<br>"},{"parent":"ef05842ffd81594a","children":[],"id":"10d5fcf257dbf002","title":"// 过滤出需要删除的货币对<br>for cp := range <b>cpsToRemove</b> {<br>&nbsp; &nbsp; if _, ok := updates.CurrencyPairs[cp]; ok {delete(<b>cpsToRemove</b>, cp)}<br>}<br>"},{"parent":"ef05842ffd81594a","children":[],"id":"e0331e8012fb8fbf","title":"// 更行存储当前支持的货币对<br>k.<b>SetCurrencyPairs</b>(updates.<b>CurrencyPairs</b>)<br>"},{"parent":"ef05842ffd81594a","children":[{"parent":"79fa584d93923fde","children":[{"parent":"b8e132b7da8554e6","children":[],"id":"ae212092f01ca4e4","title":"k.priceFeeds.Clear(prefix)"}],"id":"b8e132b7da8554e6","title":"// 删除已移除货币对对应的在此服务水平协议的喂价信息<br>for cp := range <b>cpsToRemove</b> {<br>&nbsp; &nbsp; k.<b>RemovePriceFeedByCurrencyPair</b>(sla.ID, cp);&nbsp;<br>}<br>"},{"parent":"79fa584d93923fde","children":[{"parent":"36d19ef07bb0c248","children":[{"parent":"e46e2ac7010af416","children":[],"id":"01a5c87d23682970","title":"// 校验此验证节点+货币对的喂价信息是否已存在<br><b>contains</b> := k.<b>ContainsPriceFeed</b>(sla.ID, cp, validator.ConsAddress)<br>"},{"parent":"e46e2ac7010af416","children":[{"parent":"7b4219f9ef75dabd","children":[],"id":"a3f3e532b7b52d2d","title":"// 获取指定的喂价信息<br><b>feed</b> := k.<b>GetPriceFeed</b>(sla.<b>ID</b>, <b>cp</b>, <b>validator</b>)<br>"},{"parent":"7b4219f9ef75dabd","children":[],"id":"abaa050f10873840","title":"// 更新状态<br>feed.<b>SetUpdate</b>(status);&nbsp;<br>return k.<b>SetPriceFeed</b>(ctx, feed)<br>"}],"id":"7b4219f9ef75dabd","title":"// 存在：更新此验证节点对指定货币对喂价的SLA信息<br>k.<b>updatePriceFeedWithStatus</b>(sla, cp, validator.ConsAddress, status);&nbsp;<br>"},{"parent":"e46e2ac7010af416","children":[{"parent":"60dfd7f6598b1d30","children":[{"parent":"65497210886e1d3e","children":[],"id":"0c17e6f626f405cd","title":"return <b>PriceFeed</b>{<br>&nbsp; &nbsp; <b>MaximumViableWindow</b>: uint64(maximumViableWindow),<br>&nbsp; &nbsp; <b>Validator</b>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;validator.Bytes(),<br>&nbsp; &nbsp; <b>CurrencyPair</b>:&nbsp; &nbsp; &nbsp; &nbsp; currencyPair,<br>&nbsp; &nbsp; <b>UpdateMap</b>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;updateMapBz,<br>&nbsp; &nbsp; <b>InclusionMap</b>:&nbsp; &nbsp; &nbsp; &nbsp; inclusionMapBz,<br>&nbsp; &nbsp; <b>ID</b>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; id,<br>}"}],"id":"65497210886e1d3e","title":"// 构建本节点+制定货币对的喂价，<br>// 每次<b>创建新的 SLA</b>、<b>添加新的货币</b>对或向<b>网络添加新的验证器</b>时都会调用此方法。<br><b>feed</b>:= slatypes.<b>NewPriceFeed</b>(sla.MaximumViableWindow, <b>validator</b>, <b>cp</b>, <b>sla.ID</b>)<br>"},{"parent":"60dfd7f6598b1d30","children":[],"id":"20d95956f43a7ff5","title":"// 更新喂价投票状态<br><b>feed</b>.<b>SetUpdate</b>(status)<br>"},{"parent":"60dfd7f6598b1d30","children":[],"id":"a073cf432feb84e3","title":"// 设置存储一个新的喂价信息<br>k.<b>SetPriceFeed</b>(<b>feed</b>)<br>"}],"id":"60dfd7f6598b1d30","title":"// 不存在：初始化此验证节点对指定货币对喂价的SLA信息<br>k.<b>initPriceFeedWithStatus</b>(sla, cp, validator.ConsAddress, status);&nbsp;<br>"}],"id":"e46e2ac7010af416","title":"// 遍历所有提供price的验证节点<br>// 遍历本验证节点参与投票的货币对喂价<br>for <b>validator</b> := range updates.<b>ValidatorUpdates</b> {<br>&nbsp; &nbsp; for <b>cp</b>, <b>status</b> := range <b>validator</b>.Updates {<br><br>&nbsp; &nbsp; }<br>}<br>"}],"id":"36d19ef07bb0c248","title":"// 更新sla的喂价<br>k.<b>UpdatePriceFeedsForSLA</b>(<b>sla</b>, <b>updates</b>);<br>"}],"id":"79fa584d93923fde","title":"// 更新每个 SLA 的价格信息。<br>for _, <b>sla</b> := range <b>slas</b> {<br><br>}<br>"}],"id":"ef05842ffd81594a","title":"<b><font color=\"#000000\">//在</font>Preblock</b>阶段通过投票扩展信息更新最新的Price喂价<b><font color=\"#e855a4\"><br>UpdatePriceFeeds</font></b>(updates PriceFeedUpdates)<br>"}],"id":"4e19468bf4ee5be6","title":"MsgServer"},{"parent":"a0816a897a340cbf","children":[{"parent":"9d13ee0b4a8499ae","children":[{"parent":"1d86ef8c36a4d170","children":[],"id":"ffe9a5c6689fdfe5","title":"// 获取此SLA的所有喂价信息<br>feeds := k.<b>GetAllPriceFeeds</b>(sla.ID)<br>"},{"parent":"1d86ef8c36a4d170","children":[{"parent":"d6ccfcefc67ac660","children":[{"parent":"c8f799c1a18fd07b","children":[],"id":"ae0d55d43ef20f95","title":"priceFeed.ID == sla.ID"},{"parent":"c8f799c1a18fd07b","children":[],"id":"7daf379e31147bc2","title":"priceFeed.MaximumViableWindow == sla.MaximumViableWindow"},{"parent":"c8f799c1a18fd07b","children":[],"id":"e9d4040ece6a39dc","title":"// 获取在此窗口期间喂价的投票数量<br><b>numVotes</b> := priceFeed.<b>GetNumVotesWithWindow</b>(uint(sla.MaximumViableWindow))<br>"},{"parent":"c8f799c1a18fd07b","children":[],"id":"f99c32198788b3c6","title":"// 满足需要的最小投票<br>sla.MinimumBlockUpdates) &lt;= numVotes<br>return true<br>"}],"id":"c8f799c1a18fd07b","title":"// 检测输入的价格信息是否符合 SLA 检查的条件。<br>// 如果满足以下条件，价格信息即可符合检查条件：<br>// 1. 价格信息具有与 SLA 相同的 ID / 时间窗口。<br>// 2. 价格信息已达到最大可行窗口内最小块更新的阈值<br><b>qualifies</b> := sla.<b>Qualifies</b>(<b>priceFeed</b>)<br>"},{"parent":"d6ccfcefc67ac660","children":[{"parent":"8aa4d5446416802b","children":[{"parent":"97c229cf9da5ca75","children":[],"id":"d810b76234d8d8c3","title":"// 统计在此窗口期间喂价的次数<br><b>numUpdates</b> := priceFeed.<b>GetNumPriceUpdatesWithWindow</b>(uint(sla.MaximumViableWindow))<br>"},{"parent":"97c229cf9da5ca75","children":[],"id":"4ce4cd6d49fe9a60","title":"// 统计在此窗口期间参与投票的次数<br><b>numVotes</b> := priceFeed.<b>GetNumVotesWithWindow</b>(uint(sla.MaximumViableWindow))<br>"},{"parent":"97c229cf9da5ca75","children":[],"id":"2c5b099791a9ec86","title":"uptime =&nbsp;numUpdates /&nbsp;numVotes"}],"id":"97c229cf9da5ca75","title":"// 确定价格反馈的正常运行时间。<br>//uptime = (number of price updates / number of blocks voted on)<br><b>uptime</b> := sla.<b>GetUptimeFromPriceFeed</b>(priceFeed)<br>"}],"id":"8aa4d5446416802b","title":"// EnforceSLA 检查给定的价格信息是否符合给定 SLA 的标准。<br>// 如果价格信息已达到预期正常运行时间，则不采取任何措施。<br>// 否则，验证器会因与预期正常运行时间的偏差而受到惩罚。<br>k.<b>EnforceSLA</b>(sla, priceFeed)<br>"},{"parent":"d6ccfcefc67ac660","children":[],"id":"6725292d203f051b","title":"// 满足标准版要求不需要处罚，直接退出<br>if <b>uptime</b>.GTE(sla.<b>ExpectedUptime</b>){return nil }"},{"parent":"d6ccfcefc67ac660","children":[],"id":"9d08c4fd32d2cf4a","title":"// 不满足要求惩罚此验证节点<br>// deviation = ((expected_uptime - uptime) / expected_uptime) * K<br><b>deviation</b> := (sla.ExpectedUptime - uptime)) / (sla.ExpectedUptime)<br><b>slashFactor</b> := <b>deviation *&nbsp;</b>sla.<b>SlashConstant</b><br>"},{"parent":"d6ccfcefc67ac660","children":[{"parent":"8d842c180cdd33d0","children":[],"id":"22d9e7fe416a5fa0","title":"height := ctx.BlockHeight() - sdk.ValidatorUpdateDelay<br>amount := k.slashingKeeper.<b>Slash</b>(ctx, sdk.ConsAddress(<b>validator</b>), height, power, <b>slashFactor</b>)"}],"id":"8d842c180cdd33d0","title":"// 惩罚<br>k.<b>Slash</b>( validator, power, slashFactor)<br>"}],"id":"d6ccfcefc67ac660","title":"// 遍历检查价格信息是否符合 SLA 检查/标准。<br>for _, priceFeed := range <b>feeds</b> {<br><br>}<br>"}],"id":"1d86ef8c36a4d170","title":"// 获取所有SLA并遍历执行<br>// 对其维护的所有价格信息执行 SLA 标准。<br>// 已在pre-block阶段对当前块更新了所有价格信息。<br><b>slas</b> := k.GetSLAs()<br>for _, sla := range <b>slas</b> {<br>&nbsp; &nbsp;&nbsp;k.<b>ExecSLA</b>(sla);<br>}<br>"}],"id":"9d13ee0b4a8499ae","title":"// 定时执行服务水平协议<br>BeginBlocker<br>"}],"style":{"lineStype":{"lineType":"curve","underLine":true,"lineColor":"#0F80C4","randomLineColor":"#0F80C4","lineWidth":3},"padding":"4px 14px","blob":true,"color":"#0D0B22","lineStyle":{"lineColor":"#0F80C4","randomLineColor":"#0F80C4","lineWidth":3},"textAlign":"left","font-size":"16px","font-family":"微软雅黑","italic":false},"id":"a0816a897a340cbf","title":"// 服务水平协议：检测是否按时喂价<br>//&nbsp;Preblock阶段通过扩展投票更新喂价信息<br>//&nbsp;BeginBlocker阶段执行SLA惩罚不按时喂价的验证节点<br><b>x/sla</b><br>"},{"parent":"root","lineStyle":{"lineColor":"#0F80C4","randomLineColor":"#0F80C4","lineWidth":3},"children":[{"parent":"82e3e821da56016a","children":[{"parent":"7cd16b74f55a11c2","children":[{"parent":"6fc555919627973a","children":[{"parent":"fb54a6f15a53cdd8","children":[],"id":"5d7b8fb4dcef9947","title":"<b>Alert</b>{<br>&nbsp;&nbsp;<b>Height</b>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;height,<br>&nbsp;&nbsp;<b>Signer</b>:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signer.String(),<br>&nbsp;&nbsp;<b>CurrencyPair</b>:&nbsp;cp,<br>&nbsp;}"}],"id":"fb54a6f15a53cdd8","title":"&amp;<b>MsgAlert</b>{<b>Alert</b>: a,}"},{"parent":"6fc555919627973a","children":[{"parent":"2f4fcd08b7523e17","children":[],"id":"76a63f2e1f15c2bd","title":"// 告警相关的货币对存在<br>m.k.<b>oracleKeeper</b>.<b>HasCurrencyPair</b>(req.Alert.CurrencyPair)"},{"parent":"2f4fcd08b7523e17","children":[],"id":"58567600b1d9392a","title":"// 托管告警上报者的Token<br>m.k.<b>escrowBondAmount</b>(req.Alert.<b>Signer</b>, params.AlertParams.<b>BondAmount</b>)<br>"},{"parent":"2f4fcd08b7523e17","children":[{"parent":"b0954305ba02fe14","children":[],"id":"95d63828028201e6","title":"// 告警状态：提交高度，过期时间，结论，提交时间<br>return AlertStatus{<br>&nbsp; &nbsp; <b>SubmissionHeight</b>:&nbsp; &nbsp; submissionHeight,<br>&nbsp; &nbsp; <b>PurgeHeight</b>:&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;purgeHeight,<br>&nbsp; &nbsp; <b>ConclusionStatus</b>:&nbsp; &nbsp; uint64(status),<br>&nbsp; &nbsp; <b>SubmissionTimestamp</b>: blockTimestamp,<br>}<br>"},{"parent":"b0954305ba02fe14","children":[],"id":"7baea2b66403b17d","title":"// 按照：key=(height, currency-pair) 存储<br>k.<b>alerts.Set(</b>collections.Join(alert.Alert.Height, alert.Alert.CurrencyPair.String()), alert)<br>"}],"id":"b0954305ba02fe14","title":"// 添加告警<br>m.k.<b>SetAlert</b>(<br>&nbsp; &nbsp; types.<b>NewAlertWithStatus</b>(req.Alert,<br>&nbsp; &nbsp; &nbsp; &nbsp; types.<b>NewAlertStatus</b>(height,<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <b>height</b>+params.PruningParams.<b>BlocksToPrune</b>,&nbsp;<br>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; ctx.BlockTime(),&nbsp;types.<b><font color=\"#e74f4c\">Unconcluded</font></b>,),<br>));<br>"}],"id":"2f4fcd08b7523e17","title":"<b>Alert</b>(req *types.MsgAlert)"}],"id":"6fc555919627973a","title":"//&nbsp;Create a new alert<br>//&nbsp;slinkyd tx alerts alert &lt;sender&gt; &lt;height&gt; &lt;currency-pair&gt;<br><b>AlertTxCmd</b><br>"},{"parent":"7cd16b74f55a11c2","children":[],"id":"539e3f8e11adb2d3","title":"CmdQueryParams(),<br>"},{"parent":"7cd16b74f55a11c2","children":[],"id":"d946533ae972dd2d","title":"CmdQueryAlerts(),"}],"id":"7cd16b74f55a11c2","title":"cmd"},{"parent":"82e3e821da56016a","children":[{"parent":"781d838d8b0e2366","children":[{"parent":"bbaf984ad6336bc2","children":[{"parent":"3513aadc8d5876b2","children":[],"id":"a6bf9ac298db3297","title":"// unmarshal the vote-extension<br>var voteExt slinkyabci.OracleVoteExtension<br>voteExt.Unmarshal(ve.VoteExtension);&nbsp;"},{"parent":"3513aadc8d5876b2","children":[],"id":"15ab406a8038a676","title":"// validate the alert<br>a.ValidateBasic();&nbsp;"},{"parent":"3513aadc8d5876b2","children":[],"id":"973a329b2d2a8fc8","title":"// validate the price-bound<br>pb.ValidateBasic();&nbsp;"},{"parent":"3513aadc8d5876b2","children":[],"id":"33f952caa22f0db9","title":"// 获取扩展投票中此货币对的价格信息<br>priceBz := <b>voteExt.Prices[cpID]</b><br><b>price</b>.SetBytes(priceBz)<br>"},{"parent":"3513aadc8d5876b2","children":[],"id":"87b6e516bdb004dd","title":"low := pb.GetLowInt()<br>high := pb.GetHighInt()"},{"parent":"3513aadc8d5876b2","children":[{"parent":"07c446a8668f2fec","children":[],"id":"a2e0c3109c622229","title":"// 获取投票签名的验证者地址<br>signer := sdk.AccAddressFromBech32(a.Signer)<br>"},{"parent":"07c446a8668f2fec","children":[{"parent":"1884a0a9b9aed40f","children":[],"id":"38ee36d5b028f025","title":"return &amp;ValidatorAlertIncentive{<br>&nbsp; &nbsp; Validator:&nbsp; &nbsp;validator,<br>&nbsp; &nbsp; AlertHeight: alertHeight,<br>&nbsp; &nbsp; AlertSigner: signer.String(),<br>}"}],"id":"1884a0a9b9aed40f","title":"// 构建一个验证者告警激励<br>return <b>NewValidatorAlertIncentive</b>(ve.Validator, a.Height, signer),<br>"}],"id":"07c446a8668f2fec","title":"// 检查价格是否超出范围<br>if !(price.Cmp(low) &gt;= 0) || !(price.Cmp(high) &lt;= 0)<br>"}],"id":"3513aadc8d5876b2","title":"// 默认的验证器激励措施<br>in.<b><font color=\"#ed77b6\">ValidatorIncentiveHandler</font></b> = strategies.<b>DefaultHandleValidatorIncentive</b>()<br>"}],"id":"bbaf984ad6336bc2","title":"alertsKeeper := keeper.NewKeeper(<br>in.OracleKeeper,<br>in.BankKeeper,<br>in.IncentiveKeeper,<br>in.<b><font color=\"#ed77b6\">ValidatorIncentiveHandler</font></b>,<br>authority,<br>)"},{"parent":"781d838d8b0e2366","children":[{"parent":"420fbfc41d549c58","children":[],"id":"e0d74e625d63da5c","title":"// 解析结论消息<br><b>conclusion</b> := req.<b>Conclusion</b>.GetCachedValue().(types.Conclusion)<br>"},{"parent":"420fbfc41d549c58","children":[],"id":"f69125be63e130e4","title":"// 解析结论验证参数<br>var <b>verificationParams</b> types.ConclusionVerificationParams<br>m.k.cdc.UnpackAny(<b>params</b>.<b>ConclusionVerificationParams</b>, &amp;verificationParams)<br>"},{"parent":"420fbfc41d549c58","children":[],"id":"4665a9c5a229c727","title":"// 验证结论<br><b>conclusion</b>.<b>Verify</b>(<b>verificationParams</b>)<br>"},{"parent":"420fbfc41d549c58","children":[],"id":"9e7d072cbfdb7265","title":"// 处理此结论相关的告警<br>m.k.<b>ConcludeAlert</b>(conclusion.<b>GetAlert</b>(), boolToConclusionStatus(conclusion.GetStatus()))<br>"},{"parent":"420fbfc41d549c58","children":[{"parent":"2d04e53d1856f91d","children":[],"id":"73f004e81b7dda83","title":"// 获取结论相关的扩展commit<br><b>extCommit</b> := conclusion.GetExtendedCommitInfo()<br>"},{"parent":"2d04e53d1856f91d","children":[{"parent":"91e15726de9341e9","children":[],"id":"0b1d646e9314101f","title":"// 获取结论相关的告警<br>alert := conclusion.GetAlert()<br>"},{"parent":"91e15726de9341e9","children":[],"id":"ef63ee59ed2ec923","title":"// 执行 ValidatorIncentiveHandler 来确定是否应该向验证者发出激励<br><b>incentive</b> := m.k.<b><font color=\"#ed77b6\">validatorIncentiveHandler</font></b>(<b>vote</b>, conclusion.<b>GetPriceBound</b>(), conclusion.<b>GetAlert</b>(), conclusion.<b>GetCurrencyPairID</b>())<br>"},{"parent":"91e15726de9341e9","children":[],"id":"33581381eeefdd3a","title":"// 添加激励列表<br><b>incentives</b> = append(<b>incentives</b>, <b>incentive</b>)<br>"}],"id":"91e15726de9341e9","title":"// 遍历扩展投票<br>for _, vote := range extCommit.Votes {<br><br>}"},{"parent":"2d04e53d1856f91d","children":[],"id":"9c86c004d09d6ebb","title":"// 通知激励模块添加对应的激励措施：奖励/惩罚<br>m.k.<b><font color=\"#314aa4\">incentiveKeeper</font></b>.<b><font color=\"#314aa4\">AddIncentives</font></b>(incentives)<br>"}],"id":"2d04e53d1856f91d","title":"// 正向结论奖励相关验证节点<br>conclusion.GetStatus() ==&nbsp;positive<br>"}],"id":"420fbfc41d549c58","title":"<b>Conclusion</b>(req *types.MsgConclusion)"}],"id":"781d838d8b0e2366","title":"Kepper"},{"parent":"82e3e821da56016a","children":[{"parent":"a4fe52bce965bb2f","children":[{"parent":"50d4fb1bd4422b4b","children":[],"id":"991c1de33eb0faaf","title":"type <b>AlertParams</b> struct {<br>&nbsp; &nbsp; Enabled bool&nbsp;<br>&nbsp; &nbsp; BondAmount types.Coin&nbsp;<br>&nbsp; &nbsp; MaxBlockAge uint64 <br>}<br>"},{"parent":"50d4fb1bd4422b4b","children":[],"id":"5c0fd55dca9efc5e","title":"type <b>PruningParams</b> struct {<br>&nbsp; &nbsp; Enabled bool&nbsp;<br>&nbsp; &nbsp; BlocksToPrune uint64<br>}"}],"id":"50d4fb1bd4422b4b","title":"type Params struct {<br>&nbsp; &nbsp; AlertParams <b>AlertParams</b>&nbsp;<br>&nbsp; &nbsp; ConclusionVerificationParams *types1.Any&nbsp;<br>&nbsp; &nbsp; PruningParams <b>PruningParams</b>&nbsp;<br>}"}],"id":"a4fe52bce965bb2f","title":"<b>Params</b>"},{"parent":"82e3e821da56016a","children":[{"parent":"37dd5ca05c807ebd","children":[],"id":"c5677e63c54ee689","title":"<b>height</b> := uint64(ctx.BlockHeight())<br>"},{"parent":"37dd5ca05c807ebd","children":[],"id":"8ab945b56aad08a5","title":"<b>alerts</b> := k.<b>GetAllAlerts</b>(ctx)"},{"parent":"37dd5ca05c807ebd","children":[{"parent":"f35fcb96462b2a77","children":[],"id":"52ad60245696e30c","title":"// 已经满足裁剪高度<br>alert.Status.<b><font color=\"#e855a4\">PurgeHeight</font></b> =&lt; height<br>"},{"parent":"f35fcb96462b2a77","children":[{"parent":"50b618dc3806bcaf","children":[],"id":"594c7f311d3430b3","title":"<br><br>// 最后，将警报的状态设置为已结束，并将其清除高度设置为 alert.Height + AlertParams.MaxBlockAge。<br>alert.Status.ConclusionStatus == types.<b><font color=\"#e74f4c\">Unconcluded</font></b><br>"},{"parent":"50b618dc3806bcaf","children":[{"parent":"84aff3321e045b1a","children":[],"id":"d0954dafd1483312","title":"return k.bankKeeper.<b>SendCoinsFromModuleToAccount</b>(types.<b>ModuleName</b>,a.Signer,sdk.<b>NewCoins</b>(bond),)"}],"id":"84aff3321e045b1a","title":"// 如果 Alert 以positive积极状态结束，将 Alert 的债券返回给 Alert 的所有者；<br>case <b>Positive</b>:k.<b>unescrowBond</b>(alert.Alert, params.AlertParams.<b>BondAmount</b>)<br>"},{"parent":"50b618dc3806bcaf","children":[{"parent":"53d009628f4af10e","children":[],"id":"bdfa91d4bb48705a","title":"return k.bankKeeper.<b>BurnCoins</b>(types.ModuleName,sdk.NewCoins(bond),)"}],"id":"53d009628f4af10e","title":"// 如果 Alert 以negative消极状态结束，则债券将被销毁。<br>case <b>Negative</b>:k.<b>burnBond</b>(params.AlertParams.BondAmount)<br>"},{"parent":"50b618dc3806bcaf","children":[],"id":"cf48b834c884ff6a","title":"// 更新告警状态以及裁剪高度<br>alert.Status.<b>ConclusionStatus</b> = types.<b><font color=\"#7bd144\">Concluded</font></b><br>alert.Status.<b>PurgeHeight</b> = alert.Alert.<b>Height</b> + params.AlertParams.<b>MaxBlockAge</b><br><b>return k.SetAlert(alert)</b><br>"}],"id":"50b618dc3806bcaf","title":"// 裁剪未有结论的告警，并返还token<br>alert.Status.ConclusionStatus !=&nbsp;types.<b><font color=\"#7bd144\">Concluded</font></b><br>k.<b>ConcludeAlert</b>(alert.Alert, <b>Positive</b>)<br>"},{"parent":"f35fcb96462b2a77","children":[],"id":"a9f71a4d81e00598","title":"// 删除此告警信息的记录<br>k.<b>RemoveAlert</b>(alert.Alert)<br>"}],"id":"f35fcb96462b2a77","title":"// 遍历所有告警<br>for _, alert := range alerts {<br><br><br>}<br>"}],"id":"37dd5ca05c807ebd","title":"// 定时裁剪未有结论的告警信息<br><b>EndBlocker</b><br>"}],"style":{"lineStype":{"lineType":"curve","underLine":true,"lineColor":"#0F80C4","randomLineColor":"#0F80C4","lineWidth":3},"padding":"4px 14px","blob":true,"color":"#0D0B22","lineStyle":{"lineColor":"#0F80C4","randomLineColor":"#0F80C4","lineWidth":3},"textAlign":"left","font-size":"16px","font-family":"微软雅黑","italic":false},"id":"82e3e821da56016a","title":"x/alerts"},{"parent":"root","lineStyle":{"randomLineColor":"#FD5155"},"children":[{"parent":"0f2d8dd135bdf8f1","children":[{"parent":"e16730e3e54df3e2","children":[{"parent":"6da20e703ae9986e","children":[],"id":"7ae5b603f96d3562","title":"// 遍历已存储的所有激励<br>store := ctx.KVStore(k.storeKey)<br>key := types.<b>GetIncentiveKey</b>(<b>incentive</b>)<br>it := storetypes.KVStorePrefixIterator(store, key)<br>"},{"parent":"6da20e703ae9986e","children":[],"id":"0db1e595867a2228","title":"// 挂接激励对应的执行策略<br>cb := func(incentive types.Incentive) {return <b><font color=\"#e855a4\">strategy</font></b>(incentive)}<br>"},{"parent":"6da20e703ae9986e","children":[{"parent":"d82790210f5ab26d","children":[],"id":"6b62dad927bdadcd","title":"// 解析激励<br>incentive.Unmarshal(it.Value())<br>"},{"parent":"d82790210f5ab26d","children":[],"id":"01de71adee0a8c6d","title":"// 执行激励策略<br>update := <b><font color=\"#e855a4\">cb</font></b>(incentive)<br>"},{"parent":"d82790210f5ab26d","children":[],"id":"d493c5f994165571","title":"// 激励已匹配执行完成删除此激励记录<br>store.<b>Delete</b>(it.Key())<br>"},{"parent":"d82790210f5ab26d","children":[],"id":"4c1b1a2abfc5aac0","title":"// 此激励未匹配需要更新此激励<br>store.Set(it.Key(), update.Marshal())<br>"}],"id":"d82790210f5ab26d","title":"for ; it.Valid(); it.Next() {<br>&nbsp; &nbsp;&nbsp;<br>}"}],"id":"6da20e703ae9986e","title":"// 遍历执行已支持的激励策略<br>ExecuteStrategies(){<br>&nbsp; &nbsp; for <b>incentive</b>, <b>strategy</b> := range k.<b>incentiveStrategies</b> {<br>&nbsp; &nbsp; &nbsp; &nbsp; k.<b>ExecuteIncentiveStrategy</b>(incentive, strategy);<br>&nbsp; &nbsp; }<br>}<br>"}],"id":"e16730e3e54df3e2","title":"// 定时按照激励策略奖励/惩罚<br><b>BeginBlock</b><br>"},{"parent":"0f2d8dd135bdf8f1","children":[{"parent":"bc5afcfd0ca04dd7","children":[{"parent":"173637102e42b318","children":[],"id":"61b715485eeacaee","title":"// 获取激励的全局索引值<br>index := k.<b>getIncentiveCount</b>(incentive)<br>"},{"parent":"173637102e42b318","children":[],"id":"d65b5df6cddd7635","title":"// 压缩编码激励信息<br>bz := incentive.Marshal()<br>"},{"parent":"173637102e42b318","children":[],"id":"c8e39c76e5fe06ec","title":"// 设置激励信息存入db中<br>store := ctx.KVStore(k.storeKey)<br>key := types.GetIncentiveKeyWithIndex(incentive, index+1)<br><b>store.Set(key, bz)</b>"},{"parent":"173637102e42b318","children":[],"id":"9521c38c03356a6f","title":"// 自增激励索引<br>k.<b>setIncentiveCount</b>(incentive, index+1)<br>"}],"id":"173637102e42b318","title":"// 由alerts模块添加需要奖励/惩罚的激励措施<br>for _, incentive := range incentives {<br>&nbsp; &nbsp; k.<b><font color=\"#314aa4\">addIncentive</font></b>(incentive);&nbsp;<br>}<br>"}],"id":"bc5afcfd0ca04dd7","title":"Keeper.<b><font color=\"#314aa4\">AddIncentives</font></b>(incentives)"},{"parent":"0f2d8dd135bdf8f1","children":[{"parent":"4cc84fd15f501e18","children":[{"parent":"6611e7c6814146e7","children":[],"id":"1335e633640c9864","title":"<b>GoodPriceIncentive</b>{<br>&nbsp; &nbsp; Validator:.String(),<br>&nbsp; &nbsp; Amount: .String(),<br>}"},{"parent":"6611e7c6814146e7","children":[{"parent":"a77bdedb251a6025","children":[],"id":"82ff549205921701","title":"<br>return &amp;<b>GoodPriceIncentive</b>{Validator: validator.String(),Amount:&nbsp; &nbsp; amount.String(),}<br>"}],"id":"a77bdedb251a6025","title":"<b>NewGoodPriceIncentive</b>(validator, amount )&nbsp;"},{"parent":"6611e7c6814146e7","children":[{"parent":"52d7a7b6c17c8245","children":[],"id":"604194dad5288f1f","title":"<b>goodPriceIncentive</b>, ok := incentive.(*GoodPriceIncentive)"},{"parent":"52d7a7b6c17c8245","children":[],"id":"7218a87d30cb96a6","title":"<b>validator</b> := sdk.ValAddressFromBech32(goodPriceIncentive.Validator)"},{"parent":"52d7a7b6c17c8245","children":[],"id":"5c087545fa08ca4e","title":"<b>amount</b> := badPriceIncentive.Amount"},{"parent":"52d7a7b6c17c8245","children":[],"id":"86fcc49a09b0bcf5","title":"s.bk.<b>MintCoins</b>(types.ModuleName, <b>amount</b>)"},{"parent":"52d7a7b6c17c8245","children":[],"id":"0a8c0de0a841ca41","title":"s.bk.<b>SendCoinsFromModuleToAccount</b>(types.ModuleName, <b>validator</b>, <b>amount</b>)"}],"id":"52d7a7b6c17c8245","title":"<b>// 铸币奖励验证节点<br>NewGoodPriceIncentiveStrategy</b>(&amp;s.bankKeeper).<b><font color=\"#e855a4\">GetStrategy</font></b>()<br>"}],"id":"6611e7c6814146e7","title":"// 喂价奖励策略：铸币<br><b>GoodPriceStrategy</b><br>"},{"parent":"4cc84fd15f501e18","children":[{"parent":"1ecafaef7d77c5d0","children":[],"id":"d3b4f6866d9d3c53","title":"type <b>BadPriceIncentive</b> struct {<br>&nbsp; &nbsp; <b>Validator</b> string&nbsp;// Validator 是提交不良价格的验证者的地址。<br>&nbsp; &nbsp; <b>Amount</b> string // 要削减的金额。<br>}"},{"parent":"1ecafaef7d77c5d0","children":[{"parent":"f9d224e7bd057f2a","children":[],"id":"8a2a06054061216b","title":"return &amp;BadPriceIncentive{Validator: validator.String(),Amount:&nbsp; &nbsp; amount.String(),}"}],"id":"f9d224e7bd057f2a","title":"<b>NewBadPriceIncentive</b>(validator, amount)&nbsp;<br>"},{"parent":"1ecafaef7d77c5d0","children":[{"parent":"4611b19f419ba563","children":[],"id":"904872c3aadecaae","title":"// 解析记录结构体<br><b>badPriceIncentive</b>&nbsp;:= incentive.(*BadPriceIncentive)<br>"},{"parent":"4611b19f419ba563","children":[],"id":"947c46faa536f3f6","title":"<b>validator</b> := sdk.ValAddressFromBech32(badPriceIncentive.Validator)"},{"parent":"4611b19f419ba563","children":[],"id":"85101d0a86a79f18","title":"<b>stake</b> := s.keeper.GetValidatorStake(validator)"},{"parent":"4611b19f419ba563","children":[],"id":"77e257e4d52dc82e","title":"<b>slashAmount</b> := badPriceIncentive.Amount"},{"parent":"4611b19f419ba563","children":[],"id":"9c9f418d0b7b374b","title":"s.keeper.<b>Slash</b>(validator, <b>slashAmount</b>);"}],"id":"4611b19f419ba563","title":"<b>// 消减惩罚验证节点<br>NewBadPriceIncentiveStrategy</b>(&amp;s.stakingKeeper).<b><font color=\"#e855a4\">GetStrategy</font></b>()<br>"}],"id":"1ecafaef7d77c5d0","title":"// 喂价惩罚策略：消减<br><b>BadPriceStrategy</b><br>"}],"id":"4cc84fd15f501e18","title":"// 激励策略<br><b>IncentiveStrategy</b><br>"}],"id":"0f2d8dd135bdf8f1","title":"<b>// 用于喂价的激励：奖励/惩罚<br>x/incentives</b><br>"},{"parent":"root","lineStyle":{"randomLineColor":"#80BA4C"},"children":[{"parent":"4cb3aba8ffe5b1b7","children":[],"id":"5e05b77f3fca7b55","title":"// 权限校验<br>params, err := ms.k.GetParams(ctx)<br>msg.Signer == params.MarketAuthority<br>"},{"parent":"4cb3aba8ffe5b1b7","children":[{"parent":"b6ccfbce52507d5e","children":[{"parent":"fe20701ed31b3c11","children":[],"id":"f8cc6269ab3bab26","title":"k.<b>CreateTicker</b>(ctx, ticker)"},{"parent":"fe20701ed31b3c11","children":[],"id":"3c4333d1a13ea28c","title":"k.<b>CreatePaths</b>(ctx, paths, ticker)"},{"parent":"fe20701ed31b3c11","children":[],"id":"5534e13d20826eeb","title":"k.<b>CreateProviders</b>(ctx, providers, ticker)"},{"parent":"fe20701ed31b3c11","children":[],"id":"244640af4593a245","title":"k.<b>SetLastUpdated</b>(ctx, uint64(ctx.BlockHeight()))"}],"id":"fe20701ed31b3c11","title":"ms.k.<b><font color=\"#4ccbcd\">CreateMarket</font></b>(market.<b>Ticker</b>, market.<b>Paths</b>, market.<b>Providers</b>)<br>"},{"parent":"b6ccfbce52507d5e","children":[],"id":"932472c701389124","title":"// 创建对应的货币对在预言机模块<br>ms.k.hooks.<b><font color=\"#4669ea\">AfterMarketCreated</font></b>( market.<b><font color=\"#4669ea\">Ticker</font></b>)<br>"}],"id":"b6ccfbce52507d5e","title":"// create markets<br>for market := range msg.CreateMarkets {<br><br>}<br>"}],"id":"4cb3aba8ffe5b1b7","title":"x/marketmap<br>UpdateMarketMap( msg *types.MsgUpdateMarketMap)<br>"}],"root":true,"theme":"delicate_caihong","showWatermark":false,"id":"root","title":"Skip-Mev-Slinky-Oracle","version":1425,"structure":"mind_free"}},"meta":{"exportTime":"2024-06-24 17:15:38","member":"","diagramInfo":{"creator":"","created":"2024-06-03 11:29:18","modified":"2024-06-24 17:14:40","title":"Skip-Mev-Slinky-Oracle","category":"mind_free"},"id":"665d388e659699314ded573f","type":"ProcessOn Schema File","version":"5.0"}}